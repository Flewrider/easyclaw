#!/bin/bash
# clawdy-restart — gracefully restart the Claude Code session via systemd
#
# Usage: clawdy-restart "reason" "what to resume after restart"
# Both args required — the resume note is written to ~/.easyclaw/restart-resume
# and injected into the [restart] prompt so the new session knows what to do.

if [ -z "${1:-}" ] || [ -z "${2:-}" ]; then
  echo "Usage: clawdy-restart \"reason\" \"what to resume after restart\""
  exit 1
fi

REASON="$1"
RESUME="$2"
LOG_FILE="$HOME/.easyclaw/activity-log.md"
RESUME_FILE="$HOME/.easyclaw/restart-resume"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M')

mkdir -p "$HOME/.easyclaw"

# Build mini-briefing: recent activity + pending tasks
RECENT_ACTIVITY=$(tail -3 "$LOG_FILE" 2>/dev/null | sed 's/^/  /' || echo "  (none)")
PENDING_TASKS=$(grep '^\[Pending\]' "$HOME/.easyclaw/tasks.md" 2>/dev/null | head -3 | sed 's/^/  /' || echo "  (none)")

cat > "$RESUME_FILE" <<RESUME_EOF
$RESUME

Recent activity:
$RECENT_ACTIVITY

Pending tasks:
$PENDING_TASKS
RESUME_EOF

echo "[$TIMESTAMP] system: Restarting — $REASON" >> "$LOG_FILE"
echo "Restarting claude-code service (reason: $REASON)..."
sudo systemctl restart claude-code.service
