#!/bin/bash
# claude-start.sh — starts a persistent tmux-wrapped Claude Code session.
# Accessible via: tmux attach -t claude
# Managed by systemd (claude-code.service)

# Ensure claude is on PATH (installed to ~/.local/bin by the official installer)
export PATH="%%HOME%%/.local/bin:$PATH"

SESSION="claude"
WORKDIR="%%HOME%%"
CLAUDE="%%HOME%%/.local/bin/claude"
export IS_SANDBOX=1

# Reset status to idle on every restart
mkdir -p "%%HOME%%/.easyclaw"
echo "idle" > "%%HOME%%/.easyclaw/status"

# Kill any stale tmux session
tmux kill-session -t "$SESSION" 2>/dev/null

# Start Claude Code inside tmux (restarts automatically if it crashes)
# --continue resumes the latest session; falls back to fresh start if none exists
tmux new-session -d -s "$SESSION" -c "$WORKDIR" -n "claude" \
  "while true; do $CLAUDE --dangerously-skip-permissions --continue || $CLAUDE --dangerously-skip-permissions; echo '[claude exited — restarting in 3s...]'; sleep 3; done"

# Wait for Claude to finish loading (MCP servers take time to init)
sleep 15

# Determine restart message — use agent-written resume note if present, else crash message
RESUME_FILE="%%HOME%%/.easyclaw/restart-resume"
if [ -f "$RESUME_FILE" ]; then
  RESTART_MSG=$(cat "$RESUME_FILE")
  rm -f "$RESUME_FILE"
else
  RESTART_MSG="you crashed. find out why and fix the issue then continue where you left off"
fi

# Inject startup commands — send text and Enter separately to avoid multiline paste mode
tmux send-keys -t "$SESSION:claude" "/rename %%BOT_NAME%%"
sleep 2
tmux send-keys -t "$SESSION:claude" "" C-m
sleep 5
tmux send-keys -t "$SESSION:claude" "/remote-control"
sleep 2
tmux send-keys -t "$SESSION:claude" "" C-m
sleep 8
tmux send-keys -t "$SESSION:claude" "[restart] $RESTART_MSG"
sleep 1
tmux send-keys -t "$SESSION:claude" "" C-m

# Block until tmux session ends so systemd can track and restart
while tmux has-session -t "$SESSION" 2>/dev/null; do
  sleep 2
done
