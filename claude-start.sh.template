#!/bin/bash
# claude-start.sh — starts a persistent tmux-wrapped Claude Code session.
# Accessible via: tmux attach -t claude
# Managed by systemd (claude-code.service)

# Ensure claude is on PATH (installed to ~/.local/bin by the official installer)
export PATH="%%HOME%%/.local/bin:$PATH"

SESSION="claude"
WORKDIR="%%HOME%%"
CLAUDE="%%HOME%%/.local/bin/claude"
export IS_SANDBOX=1

mkdir -p "%%HOME%%/.easyclaw"
echo "idle" > "%%HOME%%/.easyclaw/status"

# Kill any stale tmux session
tmux kill-session -t "$SESSION" 2>/dev/null

# Start Claude Code inside tmux.
# Each restart reads the restart-resume file (if present), deletes it, then launches
# claude with /remote-control as the initial prompt and the restart context baked into
# --append-system-prompt. Falls back to crash message if no resume file exists.
tmux new-session -d -s "$SESSION" -c "$WORKDIR" -n "claude" \
  "while true; do \
    RESUME=\"%%HOME%%/.easyclaw/restart-resume\"; \
    if [ -f \"\$RESUME\" ]; then \
      MSG=\$(cat \"\$RESUME\"); rm -f \"\$RESUME\"; \
    else \
      MSG=\"you crashed. find out why and fix the issue then continue where you left off\"; \
    fi; \
    $CLAUDE \"/remote-control\" --continue --dangerously-skip-permissions \
      --append-system-prompt \"RESTART CONTEXT: \$MSG\" \
    || $CLAUDE \"/remote-control\" --dangerously-skip-permissions \
      --append-system-prompt \"RESTART CONTEXT: \$MSG\"; \
    echo '[claude exited — restarting in 3s...]'; sleep 3; \
  done"

# Wait for Claude to finish loading (MCP servers take time to init)
sleep 15

# Inject "continue" — nudges Claude to read the RESTART CONTEXT from the system prompt
# and act on it (send Telegram update, resume task, etc.)
tmux send-keys -t "$SESSION:claude" "continue"
sleep 1
tmux send-keys -t "$SESSION:claude" "" C-m

# Block until tmux session ends so systemd can track and restart
while tmux has-session -t "$SESSION" 2>/dev/null; do
  sleep 2
done
